name: check and build latest image
on:
  schedule:
    - cron:  '*/30 * * * *'
  issue_comment:                                     
    types: [created]
  workflow_dispatch:
  push:
    branches:
      - main
  
jobs:
  build-and-push-image:
    strategy:
      fail-fast: false
      matrix:
        version: ['', 'reg-']
        prefix: ['', 'base-', 'go-', 'node-', 'exts-']
        include:
          - version: ''
            gcc: true
            extended: true
          - version: ''
            prefix: ''
            dockerfile: docker/default/Dockerfile
            tags: razonyang/hugo:latest,razonyang/hugo:{0}
          - version: 'reg-'
            prefix: ''
            dockerfile: docker/default/Dockerfile
            tags: razonyang/hugo:reg,razonyang/hugo:reg-{0}
          - prefix: base-
            dockerfile: docker/base/Dockerfile
            tags: razonyang/hugo:{1}base,razonyang/hugo:{2}base-{0}
          - prefix: go-
            dockerfile: docker/go/Dockerfile
            tags: razonyang/hugo:{1}go,razonyang/hugo:{2}go-{0}
          - prefix: node-
            dockerfile: docker/node/Dockerfile
            tags: razonyang/hugo:{1}node,razonyang/hugo:{2}node-{0}
          - prefix: exts-
            dockerfile: docker/exts/Dockerfile
            tags: razonyang/hugo:{1}exts,razonyang/hugo:{2}exts-{0}
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' || github.event_name == 'push' || github.event.issue.number == 3 }}
    steps:
      - name: Fetch latest Hugo release
        id: release
        run: curl https://api.github.com/repos/gohugoio/hugo/releases/latest -s | jq .tag_name -r | awk '{print "version="substr($1,2)}' >> $GITHUB_OUTPUT
        
      - name: Check if the image exists
        if: steps.release.outputs.version != 'ull'
        id: check
        run: curl https://hub.docker.com/v2/namespaces/razonyang/repositories/hugo/tags/${{ matrix.version }}${{ matrix.prefix }}${{ steps.release.outputs.version }} -s | jq 'has("name")' | awk '{print "exists="$1}' >> $GITHUB_OUTPUT 

      - name: Checkout repository
        if: steps.check.outputs.exists == 'false'
        uses: actions/checkout@v3

      - name: Set up QEMU
        if: steps.check.outputs.exists == 'false'
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        if: steps.check.outputs.exists == 'false'
        uses: docker/setup-buildx-action@v2
        with:
          driver: docker

      - name: Login to Docker Hub
        if: steps.check.outputs.exists == 'false'
        uses: docker/login-action@v2
        with:
          username: razonyang
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build the Alpine image
        if: steps.check.outputs.exists == 'false'
        uses: docker/build-push-action@v4
        with:
          context: ./docker/alpine
          file: ./docker/alpine/Dockerfile
          load: true
          tags: hugo-alpine:latest
          build-args: |
            GCC=${{ matrix.gcc }}

      - name: Build the builder image
        if: steps.check.outputs.exists == 'false'
        uses: docker/build-push-action@v4
        with:
          context: ./docker/builder
          file: ./docker/builder/Dockerfile
          load: true
          tags: hugo-builder:latest
          build-args: |
            HUGO_VERSION=v${{ steps.release.outputs.version }}
            HUGO_EXTENDED=${{ matrix.extended }}

      - name: Build and export to Docker
        if: steps.check.outputs.exists == 'false'
        uses: docker/build-push-action@v4
        with:
          load: true
          context: .
          file: ${{ matrix.dockerfile }}
          tags: razonyang/hugo:${{ matrix.version }}${{ matrix.prefix }}test
          build-args: |
            GCC=${{ matrix.gcc }}
          build-contexts: |
            alpine=docker-image://hugo-alpine:latest
            builder=docker-image://hugo-builder:latest

      - name: Test
        if: steps.check.outputs.exists == 'false'
        run: |
          docker run --rm -v $PWD/site:/src razonyang/hugo:${{ matrix.version }}${{ matrix.prefix }}test hugo

      - name: Build and push
        if: steps.check.outputs.exists == 'false'
        uses: docker/build-push-action@v4
        with:
          push: true
          context: .
          file: ${{ matrix.dockerfile }}
          tags: ${{ format(matrix.tags, steps.release.outputs.version, matrix.version, matrix.version) }}
          build-args: |
            GCC=${{ matrix.gcc }}
          build-contexts: |
            alpine=docker-image://hugo-alpine:latest
            builder=docker-image://hugo-builder:latest
